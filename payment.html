<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment - MARI E-SEVAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap');
        
        * {
            font-family: 'Roboto', sans-serif;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
        }
        
        .payment-method {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .payment-method:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .payment-method.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .input-focus:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        
        .success-message {
            display: none;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .user-dropdown {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1001;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .user-dropdown.show {
            display: block;
        }
        
        .user-dropdown a {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: background-color 0.3s;
        }
        
        .user-dropdown a:hover {
            background-color: #f1f1f1;
        }
        
        .cvv-input {
            width: 60px;
        }
        
        .expiry-input {
            width: 80px;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-spinner.show {
            display: flex;
        }
        
        .upi-qr-container {
            display: none;
            text-align: center;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .upi-qr-container.show {
            display: block;
        }
        
        .upi-timer {
            font-size: 18px;
            font-weight: bold;
            color: #ef4444;
            margin: 10px 0;
        }
        
        .payment-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .payment-status.processing {
            background-color: #fef3c7;
            color: #92400e;
            display: block;
        }
        
        .payment-status.success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .payment-status.failed {
            background-color: #fee2e2;
            color: #b91c1c;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="text-center">
            <div class="w-16 h-16 border-t-4 border-blue-600 border-solid rounded-full animate-spin mx-auto"></div>
            <p class="mt-4 text-lg font-medium">Loading application details...</p>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header-gradient text-white shadow-lg sticky-header">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center mr-3">
                        <span class="text-blue-800 font-bold text-xl">ME</span>
                    </div>
                    <h1 class="text-2xl font-bold">MARI E-SEVAI</h1>
                    <span class="ml-3 bg-yellow-400 text-blue-900 px-3 py-1 rounded-full text-sm font-semibold">Citizen Services Portal</span>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex items-center space-x-2">
                        <i class="fas fa-phone"></i>
                        <span>1800-425-1234</span>
                    </div>
                    <div class="hidden md:flex items-center space-x-2">
                        <i class="fas fa-envelope"></i>
                        <span>help@marisevai.gov.in</span>
                    </div>
                    
                    <!-- Login/Register or User Profile -->
                    <div id="authSection">
                        <!-- This will be populated by JavaScript based on auth state -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="bg-blue-900 bg-opacity-50">
            <div class="container mx-auto px-4">
                <ul class="flex flex-wrap justify-center md:justify-start space-x-1 py-2">
                    <li><a href="index.html" class="px-4 py-2 hover:bg-blue-800 rounded transition">Home</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Services</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Certificates</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Departments</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Payments</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Grievance</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Tenders</a></li>
                    <li><a href="#" class="px-4 py-2 hover:bg-blue-800 rounded transition">Contact</a></li>
                </ul>
            </div>
        </nav>
    </header>
    
    <!-- Success Message -->
    <div id="successMessage" class="success-message fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="successText">Payment successful!</span>
    </div>
    
    <!-- Error Message -->
    <div id="errorMessage" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50" style="display: none;">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <span id="errorText">Error occurred</span>
    </div>
    
    <!-- Main Content -->
    <main class="min-h-screen py-12">
        <div class="container mx-auto px-4">
            <!-- Page Title -->
            <div class="text-center mb-12">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Payment</h2>
                <p class="text-xl text-gray-600">Complete your application fee payment</p>
            </div>
            
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <!-- Application Summary -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Application Summary</h3>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">Application Type</p>
                                    <p class="font-medium" id="applicationType">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Application ID</p>
                                    <p class="font-medium" id="applicationId">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Applicant Name</p>
                                    <p class="font-medium" id="applicantName">Loading...</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Date Applied</p>
                                    <p class="font-medium" id="dateApplied">Loading...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fee Details -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Fee Details</h3>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <div class="space-y-3">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Application Fee</span>
                                    <span class="font-medium">₹250.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Processing Fee</span>
                                    <span class="font-medium">₹80.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Portal Convenience Fee</span>
                                    <span class="font-medium">₹20.00</span>
                                </div>
                                <div class="border-t border-gray-300 pt-3 mt-3">
                                    <div class="flex justify-between">
                                        <span class="text-lg font-semibold">Total Amount</span>
                                        <span class="text-lg font-bold text-blue-600">₹350.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="mb-8">
                        <h3 class="text-2xl font-semibold mb-6 text-gray-800">Select Payment Method</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="payment-method border-2 border-gray-200 rounded-lg p-4 text-center" onclick="selectPaymentMethod('card')">
                                <i class="fas fa-credit-card text-3xl text-blue-600 mb-2"></i>
                                <p class="font-medium">Credit/Debit Card</p>
                            </div>
                            <div class="payment-method border-2 border-gray-200 rounded-lg p-4 text-center" onclick="selectPaymentMethod('netbanking')">
                                <i class="fas fa-university text-3xl text-green-600 mb-2"></i>
                                <p class="font-medium">Net Banking</p>
                            </div>
                            <div class="payment-method border-2 border-gray-200 rounded-lg p-4 text-center" onclick="selectPaymentMethod('upi')">
                                <i class="fas fa-mobile-alt text-3xl text-purple-600 mb-2"></i>
                                <p class="font-medium">UPI</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Form -->
                    <form id="paymentForm" onsubmit="handlePaymentSubmit(event)">
                        <!-- Card Payment Form -->
                        <div id="cardPaymentForm" class="payment-form">
                            <h4 class="text-lg font-semibold mb-4">Card Details</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                                    <div class="relative">
                                        <input type="text" id="cardNumber" required pattern="[0-9]{16}" maxlength="16"
                                               class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg input-focus outline-none transition"
                                               placeholder="1234 5678 9012 3456">
                                        <i class="fas fa-credit-card absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                                    <input type="text" id="expiryDate" required pattern="(0[1-9]|1[0-2])\/[0-9]{2}" placeholder="MM/YY"
                                           class="expiry-input px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none transition">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                                    <input type="text" id="cvv" required pattern="[0-9]{3}" maxlength="3"
                                           class="cvv-input px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none transition"
                                           placeholder="123">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cardholder Name</label>
                                    <input type="text" id="cardholderName" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none transition"
                                           placeholder="John Doe">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Net Banking Form -->
                        <div id="netbankingForm" class="payment-form hidden">
                            <h4 class="text-lg font-semibold mb-4">Select Your Bank</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="bank" value="sbi" class="mr-2">
                                    <span>State Bank of India</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="bank" value="hdfc" class="mr-2">
                                    <span>HDFC Bank</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="bank" value="icici" class="mr-2">
                                    <span>ICICI Bank</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="bank" value="axis" class="mr-2">
                                    <span>Axis Bank</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="bank" value="pnb" class="mr-2">
                                    <span>Punjab National Bank</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input type="radio" name="bank" value="bob" class="mr-2">
                                    <span>Bank of Baroda</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- UPI Form -->
                        <div id="upiForm" class="payment-form hidden">
                            <h4 class="text-lg font-semibold mb-4">UPI Payment</h4>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">UPI ID</label>
                                <div class="relative">
                                    <input type="text" id="upiId" required pattern="[a-zA-Z0-9.\-_]{2,256}@[a-zA-Z]{2,64}"
                                           class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-lg input-focus outline-none transition"
                                           placeholder="yourname@upi">
                                    <i class="fas fa-mobile-alt absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                </div>
                            </div>
                            
                            <!-- UPI QR Code Container -->
                            <div id="upiQrContainer" class="upi-qr-container">
                                <h5 class="text-lg font-semibold mb-3">Scan QR Code to Pay</h5>
                                <div class="bg-white p-4 rounded-lg inline-block">
                                    <!-- QR Code Placeholder -->
                                    <div class="w-48 h-48 bg-gray-200 mx-auto flex items-center justify-center">
                                        <i class="fas fa-qrcode text-6xl text-gray-500"></i>
                                    </div>
                                </div>
                                <div class="upi-timer" id="upiTimer">05:00</div>
                                <p class="text-sm text-gray-600">Scan this QR code with any UPI app to complete the payment</p>
                            </div>
                            
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <p class="text-sm text-yellow-700">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    You will receive a payment request on your UPI app. Please approve the payment to complete the transaction.
                                </p>
                            </div>
                        </div>
                        
                        <!-- Billing Address -->
                        <div class="mb-6">
                            <h4 class="text-lg font-semibold mb-4">Billing Address</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                                    <input type="text" id="billingAddress" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none transition"
                                           placeholder="Street address">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                    <input type="text" id="billingCity" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none transition"
                                           placeholder="City">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">PIN Code</label>
                                    <input type="text" id="billingPin" required pattern="[0-9]{6}"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus outline-none transition"
                                           placeholder="600001">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Terms and Conditions -->
                        <div class="mb-6">
                            <label class="flex items-start">
                                <input type="checkbox" id="termsCheckbox" required class="w-4 h-4 mt-1 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-600">
                                    I agree to the 
                                    <a href="#" class="text-blue-600 hover:text-blue-800">Terms of Service</a> 
                                    and 
                                    <a href="#" class="text-blue-600 hover:text-blue-800">Refund Policy</a>
                                </span>
                            </label>
                        </div>
                        
                        <!-- Payment Status -->
                        <div id="paymentStatus" class="payment-status processing">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span id="paymentStatusText">Processing your payment...</span>
                        </div>
                        
                        <button type="submit" id="paymentSubmitBtn" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">
                            <i class="fas fa-lock mr-2"></i>Pay ₹350.00
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-900 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                            <span class="text-white font-bold text-lg">ME</span>
                        </div>
                        <h3 class="text-xl font-bold">MARI E-SEVAI</h3>
                    </div>
                    <p class="text-gray-400 mb-4">Your trusted portal for government services and certificates.</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="index.html" class="hover:text-white transition">Home</a></li>
                        <li><a href="#" class="hover:text-white transition">About Us</a></li>
                        <li><a href="#" class="hover:text-white transition">Services</a></li>
                        <li><a href="#" class="hover:text-white transition">FAQs</a></li>
                        <li><a href="#" class="hover:text-white transition">Contact</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Popular Services</h4>
                    <ul class="space-y-2 text-gray-400">
                        <li><a href="birth-certificate.html" class="hover:text-white transition">Birth Certificate</a></li>
                        <li><a href="death-certificate.html" class="hover:text-white transition">Death Certificate</a></li>
                        <li><a href="income-certificate.html" class="hover:text-white transition">Income Certificate</a></li>
                        <li><a href="community-certificate.html" class="hover:text-white transition">Community Certificate</a></li>
                        <li><a href="driving-license.html" class="hover:text-white transition">Driving License</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contact Us</h4>
                    <ul class="space-y-3 text-gray-400">
                        <li class="flex items-start">
                            <i class="fas fa-map-marker-alt mt-1 mr-3"></i>
                            <span>E-Sevai Center, Government Complex, Chennai - 600001</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-3"></i>
                            <span>1800-425-1234</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-3"></i>
                            <span>help@marisevai.gov.in</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-clock mr-3"></i>
                            <span>Mon-Fri: 9:00 AM - 6:00 PM</span>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-800 mt-10 pt-6 text-center text-gray-400">
                <p>&copy; 2024 MARI E-SEVAI. All rights reserved. | Designed and Developed by Government of Tamil Nadu</p>
            </div>
        </div>
    </footer>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyANmru4_kH0eDNgDFURF5aZTaiPgaQ4avU",
            authDomain: "vipteammod-movies.firebaseapp.com",
            projectId: "vipteammod-movies",
            databaseURL: "https://vipteammod-movies-default-rtdb.firebaseio.com",
            appId: "1:1024721077525:android:c25e4ab10ec8e4166ad51c"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Global variables
        let currentApplicationId = null;
        let applicationData = null;
        let upiTimerInterval = null;
        let paymentCheckInterval = null;
        
        // Check auth state and update UI
        auth.onAuthStateChanged((user) => {
            const authSection = document.getElementById('authSection');
            
            if (user) {
                // User is signed in
                const userEmail = user.email;
                
                authSection.innerHTML = `
                    <div class="relative">
                        <button onclick="toggleUserDropdown()" class="flex items-center bg-white text-blue-800 px-4 py-2 rounded-md font-semibold hover:bg-blue-100 transition">
                            <i class="fas fa-user-circle mr-2"></i>
                            <span class="truncate max-w-xs">${userEmail}</span>
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div id="userDropdown" class="user-dropdown">
                            <a href="#" class="block px-4 py-3 text-gray-800 hover:bg-blue-50 transition">
                                <i class="fas fa-user mr-2"></i> My Profile
                            </a>
                            <a href="#" class="block px-4 py-3 text-gray-800 hover:bg-blue-50 transition">
                                <i class="fas fa-file-alt mr-2"></i> My Applications
                            </a>
                            <a href="#" class="block px-4 py-3 text-gray-800 hover:bg-blue-50 transition">
                                <i class="fas fa-cog mr-2"></i> Settings
                            </a>
                            <div class="border-t border-gray-200 my-1"></div>
                            <a href="#" onclick="logout()" class="block px-4 py-3 text-red-600 hover:bg-red-50 transition">
                                <i class="fas fa-sign-out-alt mr-2"></i> Logout
                            </a>
                        </div>
                    </div>
                `;
                
                // Load application data after user is authenticated
                loadApplicationData();
            } else {
                // User is signed out
                authSection.innerHTML = `
                    <a href="login.html" class="bg-white text-blue-800 px-4 py-2 rounded-md font-semibold hover:bg-blue-100 transition">
                        <i class="fas fa-user mr-2"></i>Login / Register
                    </a>
                `;
                
                // Redirect to login if not authenticated
                window.location.href = "login.html";
            }
        });
        
        // Load application data from Firebase
        function loadApplicationData() {
            const user = auth.currentUser;
            if (!user) return;
            
            // Show loading spinner
            document.getElementById('loadingSpinner').classList.add('show');
            
            // Get application ID from URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const applicationId = urlParams.get('id');
            
            if (applicationId) {
                currentApplicationId = applicationId;
                
                // Fetch application data from Firebase
                database.ref('birthCertificateApplications/' + user.uid + '/' + applicationId).once('value')
                    .then((snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            applicationData = data;
                            updateApplicationSummary(data);
                        } else {
                            showErrorMessage('Application not found');
                        }
                        
                        // Hide loading spinner
                        document.getElementById('loadingSpinner').classList.remove('show');
                    })
                    .catch((error) => {
                        console.error('Error fetching application data:', error);
                        showErrorMessage('Error loading application data');
                        
                        // Hide loading spinner
                        document.getElementById('loadingSpinner').classList.remove('show');
                    });
            } else {
                // No application ID in URL, try to get the most recent application
                database.ref('birthCertificateApplications/' + user.uid).orderByChild('timestamp').limitToLast(1).once('value')
                    .then((snapshot) => {
                        snapshot.forEach((childSnapshot) => {
                            const data = childSnapshot.val();
                            currentApplicationId = childSnapshot.key;
                            applicationData = data;
                            updateApplicationSummary(data);
                        });
                        
                        // Hide loading spinner
                        document.getElementById('loadingSpinner').classList.remove('show');
                    })
                    .catch((error) => {
                        console.error('Error fetching recent application:', error);
                        showErrorMessage('No application found');
                        
                        // Hide loading spinner
                        document.getElementById('loadingSpinner').classList.remove('show');
                    });
            }
        }
        
        // Update application summary with data from Firebase
        function updateApplicationSummary(data) {
            document.getElementById('applicationType').textContent = 'Birth Certificate';
            document.getElementById('applicationId').textContent = currentApplicationId || 'N/A';
            document.getElementById('applicantName').textContent = data.childName || 'N/A';
            
            // Format date
            const dateApplied = data.timestamp ? new Date(data.timestamp).toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            }) : 'N/A';
            document.getElementById('dateApplied').textContent = dateApplied;
            
            // Pre-fill billing address if available
            if (data.address) {
                document.getElementById('billingAddress').value = data.address.houseNoStreet || '';
                document.getElementById('billingCity').value = data.address.villageTownCity || '';
                document.getElementById('billingPin').value = data.address.pinCode || '';
            }
        }
        
        // Toggle user dropdown menu
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.relative') && !event.target.closest('.relative')) {
                const dropdown = document.getElementById('userDropdown');
                if (dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
            }
        }
        
        // Handle logout
        function logout() {
            auth.signOut().then(() => {
                // Sign-out successful
                window.location.reload();
            }).catch((error) => {
                // An error happened
                console.error('Logout error:', error);
            });
        }
        
        // Payment method selection
        let selectedPaymentMethod = 'card';
        
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show/hide payment forms
            document.querySelectorAll('.payment-form').forEach(form => {
                form.classList.add('hidden');
            });
            
            if (method === 'card') {
                document.getElementById('cardPaymentForm').classList.remove('hidden');
            } else if (method === 'netbanking') {
                document.getElementById('netbankingForm').classList.remove('hidden');
            } else if (method === 'upi') {
                document.getElementById('upiForm').classList.remove('hidden');
            }
        }
        
        // Handle payment form submission
        function handlePaymentSubmit(event) {
            event.preventDefault();
            
            // Check if user is logged in
            const user = auth.currentUser;
            if (!user) {
                alert('Please login to complete the payment');
                window.location.href = 'login.html';
                return;
            }
            
            // Validate form based on payment method
            let isValid = true;
            
            if (selectedPaymentMethod === 'card') {
                const cardNumber = document.getElementById('cardNumber').value;
                const expiryDate = document.getElementById('expiryDate').value;
                const cvv = document.getElementById('cvv').value;
                const cardholderName = document.getElementById('cardholderName').value;
                
                if (!cardNumber || !expiryDate || !cvv || !cardholderName) {
                    isValid = false;
                    showErrorMessage('Please fill all card details');
                }
            } else if (selectedPaymentMethod === 'netbanking') {
                const selectedBank = document.querySelector('input[name="bank"]:checked');
                if (!selectedBank) {
                    isValid = false;
                    showErrorMessage('Please select your bank');
                }
            } else if (selectedPaymentMethod === 'upi') {
                const upiId = document.getElementById('upiId').value;
                if (!upiId) {
                    isValid = false;
                    showErrorMessage('Please enter your UPI ID');
                }
            }
            
            // Check billing address
            const billingAddress = document.getElementById('billingAddress').value;
            const billingCity = document.getElementById('billingCity').value;
            const billingPin = document.getElementById('billingPin').value;
            
            if (!billingAddress || !billingCity || !billingPin) {
                isValid = false;
                showErrorMessage('Please fill all billing address fields');
            }
            
            // Check terms and conditions
            const termsCheckbox = document.getElementById('termsCheckbox');
            if (!termsCheckbox.checked) {
                isValid = false;
                showErrorMessage('Please accept the terms and conditions');
            }
            
            if (!isValid) {
                return;
            }
            
            // Simulate payment processing
            const submitButton = document.getElementById('paymentSubmitBtn');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
            
            // Create payment data
            const paymentData = {
                amount: 350,
                method: selectedPaymentMethod,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'processing',
                transactionId: 'TXN' + Date.now()
            };
            
            // Update application with payment information
            database.ref('birthCertificateApplications/' + user.uid + '/' + currentApplicationId).update({
                payment: paymentData,
                status: 'payment_processing'
            })
            .then(() => {
                // Show payment status
                const paymentStatus = document.getElementById('paymentStatus');
                paymentStatus.className = 'payment-status processing';
                document.getElementById('paymentStatusText').textContent = 'Processing your payment...';
                
                // For UPI payment, show QR code and start timer
                if (selectedPaymentMethod === 'upi') {
                    document.getElementById('upiQrContainer').classList.add('show');
                    startUpiTimer();
                    
                    // Simulate UPI payment request
                    simulateUpiPayment();
                } else {
                    // Simulate payment processing for card/netbanking
                    simulateCardOrNetbankingPayment();
                }
            })
            .catch((error) => {
                console.error('Error saving payment data:', error);
                showErrorMessage('Error processing payment');
                
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Pay ₹350.00';
            });
        }
        
        // Simulate UPI payment
        function simulateUpiPayment() {
            // Check payment status every 2 seconds
            paymentCheckInterval = setInterval(() => {
                // Simulate random payment success (80% success rate)
                if (Math.random() < 0.8) {
                    clearInterval(paymentCheckInterval);
                    clearInterval(upiTimerInterval);
                    
                    // Update payment status to completed
                    completePayment();
                }
            }, 2000);
            
            // If payment doesn't complete in 5 minutes, show timeout
            setTimeout(() => {
                if (paymentCheckInterval) {
                    clearInterval(paymentCheckInterval);
                    clearInterval(upiTimerInterval);
                    
                    // Show payment failed
                    const paymentStatus = document.getElementById('paymentStatus');
                    paymentStatus.className = 'payment-status failed';
                    document.getElementById('paymentStatusText').textContent = 'Payment timed out. Please try again.';
                    
                    // Re-enable submit button
                    const submitButton = document.getElementById('paymentSubmitBtn');
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Pay ₹350.00';
                }
            }, 300000); // 5 minutes
        }
        
        // Simulate card or netbanking payment
        function simulateCardOrNetbankingPayment() {
            // Simulate payment processing time (3-5 seconds)
            const processingTime = 3000 + Math.random() * 2000;
            
            setTimeout(() => {
                // Simulate random payment success (90% success rate for card/netbanking)
                if (Math.random() < 0.9) {
                    completePayment();
                } else {
                    // Show payment failed
                    const paymentStatus = document.getElementById('paymentStatus');
                    paymentStatus.className = 'payment-status failed';
                    document.getElementById('paymentStatusText').textContent = 'Payment failed. Please try again.';
                    
                    // Re-enable submit button
                    const submitButton = document.getElementById('paymentSubmitBtn');
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Pay ₹350.00';
                }
            }, processingTime);
        }
        
        // Complete payment process
        function completePayment() {
            const user = auth.currentUser;
            
            // Update payment status to completed
            database.ref('birthCertificateApplications/' + user.uid + '/' + currentApplicationId + '/payment').update({
                status: 'completed'
            })
            .then(() => {
                // Update application status
                return database.ref('birthCertificateApplications/' + user.uid + '/' + currentApplicationId).update({
                    status: 'under_review'
                });
            })
            .then(() => {
                // Show payment success
                const paymentStatus = document.getElementById('paymentStatus');
                paymentStatus.className = 'payment-status success';
                document.getElementById('paymentStatusText').textContent = 'Payment successful! Your application is under review.';
                
                // Show success message
                showSuccessMessage('Payment successful! Your application has been submitted successfully.');
                
                // Redirect to success page or dashboard
                setTimeout(() => {
                    window.location.href = 'payment-success.html?id=' + currentApplicationId;
                }, 3000);
            })
            .catch((error) => {
                console.error('Error updating payment status:', error);
                showErrorMessage('Payment successful but error updating application status');
                
                // Re-enable submit button
                const submitButton = document.getElementById('paymentSubmitBtn');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Pay ₹350.00';
            });
        }
        
        // Start UPI timer
        function startUpiTimer() {
            let timeLeft = 300; // 5 minutes in seconds
            
            upiTimerInterval = setInterval(() => {
                timeLeft--;
                
                if (timeLeft <= 0) {
                    clearInterval(upiTimerInterval);
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                
                document.getElementById('upiTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Show success message
        function showSuccessMessage(message) {
            const successDiv = document.getElementById('successMessage');
            const successText = document.getElementById('successText');
            
            successText.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }
        
        // Show error message
        function showErrorMessage(message) {
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Format card number input
        document.getElementById('cardNumber').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedInputValue = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formattedInputValue;
        });
        
        // Format expiry date input
        document.getElementById('expiryDate').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
        
        // CVV input validation
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 3);
        });
        
        // PIN code input validation
        document.getElementById('billingPin').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Select card payment method by default
            document.querySelector('.payment-method').click();
        });
    </script>
</body>
</html>